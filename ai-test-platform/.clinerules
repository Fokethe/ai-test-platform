# Cline 智能助手规则配置
# 版本: 1.0 | 适用: ai-test-platform 项目

================================================================================
## Skill 1: 成本控制协议 (Cost Control)
================================================================================
【触发方式】: 每轮对话自动执行，无需用户触发

【规则】:
- 读取文件 > 5,000 字符时: "📊 读取此文件预估消耗: ${cost} (约 {n} tokens)"
- 批量修改 > 3 个文件时: "⚠️ 批量修改预估消耗: ${cost}，建议分批处理"
- 单轮累计 > $0.05 时: 必须询问 "预估消耗 ${cost}，是否继续? [Y/N]"
- 单轮累计 > $0.10 时: 提示 "💡 建议开启新对话或执行 /compact 压缩上下文"

================================================================================
## Skill 2: 大文档分段处理协议 (Doc Processor)
================================================================================
【触发方式】: 检测到引用文件字符数 > 30,000 时自动激活，或用户说"整理文档"、"处理大文件"

【执行流程】:
1. **立即停止**: "检测到大型文档 (约 {n} 字符)，触发分段协议"
2. **结构分析**: 输出文档地图，建议分为 {x} 段 (每段 5,000-8,000 字符)
3. **制定计划**: 
分块方案:
 
块1: [章节范围] - 约 {n} 字 - 主题: {topic}
 
块2: [章节范围] - 约 {n} 字 - 主题: {topic}  ...
4. **逐块处理**: 等待用户发送第 1 块，处理完再要第 2 块，禁止主动读取全文
5. **最终整合**: 所有块完成后输出合并方案和去重结果

【禁止事项】:
- 禁止一次性读取 > 5 万字
- 禁止未制定分块计划前直接回答内容摘要

================================================================================
## Skill 3: 代码重构协议 (Code Refactor)
================================================================================
【触发方式】: 用户输入"重构"、"优化代码"、"重构 {文件名}"、"整理项目结构"

【执行策略】:
1. **依赖分析**: 使用 Read/Glob 分析文件关系，识别底层工具 (utils) → 业务逻辑 (services) → UI 层 (components)
2. **分批修改**: 每次最多处理 3 个紧密关联的文件
3. **安全原则**:
- 保持函数签名向后兼容
- 修改前输出 diff 对比
- 建议用户先 `git add .` 再应用修改
4. **输出格式**:
🔧 重构计划: {模块名}  ├── 文件1: {文件名} - 修改点: {简述}  ├── 文件2: {文件名} - 修改点: {简述}  └── 依赖检查: {是否影响其他文件}
[diff 对比]
【约束】:
- 禁止自动执行 rm/drop 等危险命令
- 修改后必须询问 "是否应用这些修改?"

================================================================================
## Skill 4: 任务拆解与规划协议 (Task Planner)
================================================================================
【触发方式】: 用户提出复杂需求含"实现"、"开发"、"做个系统"、"添加功能"、"从零开始"等关键词，且需求涉及多步骤时

【强制步骤】:
1. **暂停编码**: 不要立即写代码
2. **输出计划**:
📋 执行计划: {任务名}  预估总消耗: ${cost} | 预计 {n} 轮对话
阶段 1: 准备与调研
 
分析现有代码结构
 
识别依赖关系
阶段 2: 实施
 
{步骤1} → 产出: {文件}
 
{步骤2} → 产出: {文件}
阶段 3: 验证
 
运行测试/检查错误
3. **等待确认**: "是否按此计划执行? 或有调整?"
4. **分阶段执行**: 每完成一个阶段输出进度，询问 "继续下一阶段?"

================================================================================
## Skill 5: 代码审查协议 (Code Review)
================================================================================
【触发方式】: 用户说"审查代码"、"review"、"检查这段代码"、"看看有什么问题"

【检查清单】:
- [ ] **可读性**: 变量名语义化? 函数长度 < 50 行?
- [ ] **重复代码**: 是否有可提取的公共逻辑?
- [ ] **错误处理**: 异步错误、空值、边界情况是否处理?
- [ ] **性能**: 是否有循环嵌套、重复计算?
- [ ] **安全**: SQL 注入、XSS、敏感信息硬编码?
- [ ] **类型安全**: TypeScript 是否有 any 类型滥用?

【输出格式】:
🔍 审查结果: {文件名} 风险等级: 🔴 高 / 🟡 中 / 🟢 低
主要问题:
1. 
[问题] - 建议: [具体修改]
2. 
...
优化建议:
 
建议提取函数: {函数名} (重复出现在第 X,Y 行)
 
建议重命名: {旧} → {新}
✅ 可保留部分: {写得好的地方}

================================================================================
## Skill 6: Git 提交规范 (Commit Convention)
================================================================================
【触发方式】: 用户说"生成提交信息"、"写 commit"、"commit message"、"这次改动怎么提交"

【格式模板】:
<type>(<scope>): <subject>
<body>
<footer>
```
【Type 定义】:
 
 feat : 新功能
 
 fix : Bug 修复
 
 docs : 文档更新
 
 style : 代码格式 (不影响功能)
 
 refactor : 重构
 
 test : 测试相关
 
 chore : 构建/工具变动
【规则】:
1. 
Subject (第一行): 不超过 50 字符，使用祈使句 ("添加" 而非 "添加了")，首字母小写，末尾不加句号
2. 
Body (详细说明): 说明改动原因 (why)，而非改动内容 (what)，每行不超过 72 字符
3. 
Footer (可选): 破坏性变更标注  BREAKING CHANGE: {描述} ，关联 Issue 标注  Closes #{issue号} 
【示例输出】:
feat(auth): 添加 JWT token 刷新机制

- 添加 token 过期自动刷新逻辑
- 在 axios 拦截器中处理 401 错误
- 添加刷新队列避免重复请求

解决了用户长时间操作后需要重新登录的问题

Closes #234

================================================================================
## Skill 7: 项目知识库上下文 (Project Context)
================================================================================
【触发方式】: 用户提及"根据规范"、"按项目风格"、"文档里说的"，或需要了解项目结构时自动引用

【项目结构】:
 
 docs/ : 文档目录 (PRD, 开发指南, 测试规范, Prompt库)
   ├── PRD/ : 产品需求文档
   ├── DEV/ : 开发文档
   ├── TEST/ : 测试规范
   ├── PROMPT/ : AI Prompt库
   └── AUX/ : 辅助文档 (CLAUDE.md, GUIDE.md)
 
 src/ : 源码，按功能域组织
   ├── app/ : Next.js 页面和API路由
   ├── components/ui/ : shadcn/ui 组件
   ├── lib/ : 工具函数和Hooks
   │   ├── ai/ : AI客户端和Prompts
   │   ├── hooks/ : 自定义Hooks
   │   └── playwright/ : 测试执行器
   └── types/ : TypeScript类型定义
 
 prisma/ : 数据库模型和迁移

【技术栈约束】:
 
框架: Next.js 16 + React 19 + TypeScript
 
样式: Tailwind CSS v4 + shadcn/ui 组件
 
数据库: Prisma ORM + SQLite(开发)/PostgreSQL(生产)
 
认证: NextAuth.js v4
 
图标: Lucide React (禁止其他图标库)
 
AI SDK: @ai-sdk/openai + ai
 
测试: Playwright
 
代码风格: 单引号，无分号，2 空格缩进

【强制规范】:
 
Mobile-first: 默认移动端，断点 sm: md: lg:
 
组件: 函数式 + Hooks，禁止 Class 组件
 
类型: 禁止 any，所有 API 返回定义 interface
 
样式: 只用 Tailwind 标准色 slate/blue，禁止 arbitrary values
 
文件路径: 页面用 src/app/[route]/page.tsx，API用 src/app/api/[route]/route.ts
 
禁止组件中直接调用 axios，必须使用封装后的 lib/ai/client.ts
 
禁止硬编码 API URL，使用环境变量
 
禁止使用 any 类型，必须用具体类型或 unknown

【数据模型层级】:
 
Workspace（工作空间）
   └── Project（项目）
         └── System（系统）
               └── Page（页面）
                     └── TestCase（测试用例）

【权限模型】:
 
ADMIN: 全部权限（用户管理、系统配置）
 
USER: 工作空间管理、测试用例管理
 
GUEST: 只读访问

【优先级引用】: 当用户提及规范时，优先读取:  docs/KIMI.md > docs/CLAUDE.md > docs/GUIDE.md > docs/PRD.md > 本规则

================================================================================
## Skill 8: AI 测试平台专用协议 (AI Test Platform)
================================================================================
【触发方式】: 用户提及"生成用例"、"测试执行"、"AI测试"、"Playwright"、"测试套件"等关键词

【AI 生成用例规范】:
- 必须使用 lib/ai/prompts.ts 中的标准 Prompt 模板
- 生成策略必须包含: 正向用例、反向用例、边界值用例
- 用例格式: 标题、前置条件、步骤(数组)、预期结果
- 用例优先级: P0(核心)/P1(重要)/P2(一般)/P3(低优先级)

【测试执行规范】:
- 测试执行必须使用 lib/playwright/runner.ts 封装
- 执行环境: 云端浏览器(Playwright)或本地浏览器
- 执行记录必须包含: 日志、截图(失败时)、耗时统计
- 支持并发执行，但需控制并发数避免资源耗尽

【数据模型操作规范】:
- 涉及数据库变更时，必须同时更新:
  1. prisma/schema.prisma 模型定义
  2. 相关的种子数据 (prisma/seed.ts)
  3. 类型定义 (src/types/)
  4. API 路由 (src/app/api/)
- 数据库迁移命令: npm run db:migrate
- 种子数据重置: npm run db:seed

【层级管理规范】:
- 创建顺序: Workspace → Project → System → Page → TestCase
- 删除上级资源时，必须提示用户将级联删除下级资源
- 权限检查: 每个 API 必须验证用户是否有权操作该资源

【UI/UX 规范】:
- 使用 shadcn/ui 组件库，禁止引入其他 UI 库
- 表单必须使用 react-hook-form + zod 验证
- 列表页必须包含: 搜索、分页、空状态处理
- 详情页必须包含: 面包屑导航、返回按钮、操作按钮

================================================================================
## 系统指令 (System Instructions)
================================================================================
【全局约束】:
1. 
回复使用中文，技术术语保留英文 (如 API, Token, diff)
2. 
每轮回复必须包含 Token 成本预估 (Skill 1 要求)
3. 
遇到冲突规则时，优先级: Cost Control > Doc Processor > 其他
4. 
上下文占用 > 60% 时主动提示: "💡 上下文即将满载，建议开新对话"

【快捷指令支持】:
 
用户输入  /next : 继续下一阶段/下一块内容
 
用户输入  /plan : 重新生成分段/任务计划
 
用户输入  /cost : 显示当前累计消耗

---

## 使用说明

**保存位置**: 项目根目录 `ai-test-platform/.clinerules`

**立即测试**:
1. 保存文件后，**重启 Cline 对话**（点 + 号新建）
2. 引用你的大文件：`@Kimi_Code_Vibe_Coding_Guide.md 帮我整理`
3. 应该触发 **Skill 2**，显示分段提示而不是直接读取

**后续调整**:
- 如果某个 Skill 太敏感（频繁误触发），修改其【触发方式】描述，加更多关键词限制
- 如果规则太长导致 Cline 加载慢，可以删掉暂不需要的 Skill（如暂时不用 Skill 5 代码审查）
